<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>RPG PLAYER HUD - ULTIMATE ENGINE</title>
    <!-- Import fontov -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=EB+Garamond:ital,wght@0,400;1,700&display=swap" rel="stylesheet">
    
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; overflow: hidden; 
            display: flex; justify-content: center; align-items: center; 
            font-family: 'EB Garamond', serif; 
        }

        /* Hlavná scéna, ktorá drží pomer strán mapy */
        #stage { 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            max-width: 100vw; 
            max-height: 100vh; 
        }

        /* Vrstva 1: Hlavná Mapa */
        #map-img { 
            max-width: 100vw; 
            max-height: 100vh; 
            object-fit: contain; 
            z-index: 1; 
            transition: filter 1s ease; 
        }

        /* Vrstva 2: Fog of War (Hmla) */
        #fog-canvas { 
            position: absolute; 
            z-index: 5; 
            pointer-events: none; 
            /* Pozícia sa dopočítava v JS podľa mapy */
        }

        /* Vrstva 3: Mini Mapa (Focus) */
        #mini-map { 
            position: absolute; 
            z-index: 10; 
            max-width: 75%; 
            max-height: 75%; 
            border: 3px solid #d4af37; 
            box-shadow: 0 0 50px rgba(0,0,0,1); 
            opacity: 0; 
            transform: scale(0); 
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        #mini-map.active { opacity: 1; transform: scale(1); }

        /* Vrstva 4: Pergament (Scroll) */
        #scroll { 
            position: absolute; 
            z-index: 50; 
            width: 500px; 
            padding: 50px; 
            background: #f4e4bc; 
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
            border: 2px solid #d4af37;
            box-shadow: 0 0 100px rgba(0,0,0,1); 
            color: #2c1e14; 
            transform: scaleY(0); 
            opacity: 0; 
            transform-origin: top;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: none; 
            text-align: center;
            cursor: pointer;
        }
        #scroll.active { display: block; transform: scaleY(1); opacity: 1; }
        #scroll-text { font-family: 'Cinzel Decorative', cursive; font-size: 22px; line-height: 1.5; }
        
        /* Efekty */
        .blurred { filter: blur(10px) brightness(0.3); }
        
        #title-card { 
            position: absolute; 
            width: 100%; 
            text-align: center; 
            top: 40%; 
            z-index: 100;
            font-family: 'Cinzel Decorative'; 
            font-size: 60px; 
            color: white; 
            opacity: 0; 
            text-shadow: 0 0 20px gold;
            transition: opacity 1s ease;
            pointer-events: none;
        }

        /* Status indikátor */
        #status { 
            position: absolute; top: 10px; right: 10px; 
            color: #333; font-family: monospace; font-size: 10px; z-index: 1000; 
        }
    </style>
</head>
<body>

    <div id="status">WS: CONNECTING...</div>

    <div id="stage">
        <!-- Mapa na pozadí -->
        <img id="map-img" src="" alt="">
        
        <!-- Plátno pre hmlu -->
        <canvas id="fog-canvas"></canvas>
        
        <!-- Prekrytie mini-mapou -->
        <img id="mini-map" src="" alt="">
        
        <!-- Pergamen s textom -->
        <div id="scroll" onclick="this.classList.toggle('active')">
            <div id="scroll-text"></div>
        </div>

        <!-- Nápis lokality -->
        <div id="title-card"></div>
    </div>

    <script>
        const status = document.getElementById('status');
        const mapImg = document.getElementById('map-img');
        const fogCanvas = document.getElementById('fog-canvas');
        const fogCtx = fogCanvas.getContext('2d');
        const miniMap = document.getElementById('mini-map');
        const scroll = document.getElementById('scroll');
        const scrollText = document.getElementById('scroll-text');
        const titleCard = document.getElementById('title-card');

        // --- KONFIGURÁCIA SERVERA ---
        const WS_URL = "wss://dnd-server-3.onrender.com/ws";
        let socket;

        // --- SYNCHRONIZÁCIA HMLE S MAPOU ---
        function syncFog() {
            if (!mapImg.src || mapImg.clientWidth === 0) return;

            // Hmla musí mať presne tie isté rozmery a pozíciu ako mapa v strede
            fogCanvas.width = mapImg.clientWidth;
            fogCanvas.height = mapImg.clientHeight;
            fogCanvas.style.left = mapImg.offsetLeft + "px";
            fogCanvas.style.top = mapImg.offsetTop + "px";

            // Zadebniť na čierno
            fogCtx.globalCompositeOperation = 'source-over';
            fogCtx.fillStyle = "black";
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            console.log("Hmla inicializovaná pre mapu:", fogCanvas.width, "x", fogCanvas.height);
        }

        mapImg.onload = syncFog;
        window.onresize = syncFog;

        // --- PRIPOJENIE ---
        function connect() {
            socket = new WebSocket(WS_URL);

            socket.onopen = () => {
                status.innerText = "WS: CONNECTED";
                status.style.color = "green";
                console.log("Pripojené na server.");
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("Prijatý príkaz:", data);

                // 1. Zmena hlavnej mapy
                if (data.type === "bg_map") {
                    mapImg.src = data.url;
                }

                // 2. Odkrývanie hmly (Reveal)
                if (data.type === "reveal") {
                    // Prepočet % súradníc (0-1) na pixely plátna
                    const x = data.x * fogCanvas.width;
                    const y = data.y * fogCanvas.height;

                    fogCtx.globalCompositeOperation = 'destination-out';
                    fogCtx.beginPath();
                    fogCtx.arc(x, y, 60, 0, Math.PI * 2); // Polomer gumy: 60px
                    fogCtx.fill();
                }

                // 3. Mini-mapa (Mesto/Dom)
                if (data.type === "mini_map") {
                    miniMap.src = data.url;
                    miniMap.classList.add('active');
                    mapImg.classList.add('blurred');
                }

                // 4. Pergament (Scroll)
                if (data.type === "scroll") {
                    scrollText.innerText = data.text;
                    scroll.style.display = "block";
                    setTimeout(() => scroll.classList.add('active'), 50);
                    mapImg.classList.add('blurred');
                    new Audio('https://www.soundjay.com/misc/sounds/paper-unfold-1.mp3').play().catch(e=>{});
                }

                // 5. Title Reveal (Nápis lokality)
                if (data.type === "title") {
                    titleCard.innerText = data.text;
                    titleCard.style.opacity = 1;
                    setTimeout(() => { titleCard.style.opacity = 0; }, 4000);
                }

                // 6. Čistenie vrstiev
                if (data.type === "clear") {
                    if (data.target === "fog") syncFog();
                    if (data.target === "mini") {
                        miniMap.classList.remove('active');
                        if (!scroll.classList.contains('active')) mapImg.classList.remove('blurred');
                    }
                    if (data.target === "scroll") {
                        scroll.classList.remove('active');
                        setTimeout(() => { scroll.style.display = "none"; }, 800);
                        if (!miniMap.classList.contains('active')) mapImg.classList.remove('blurred');
                    }
                    if (data.target === "all") {
                        mapImg.src = "";
                        miniMap.classList.remove('active');
                        scroll.classList.remove('active');
                        mapImg.classList.remove('blurred');
                        initFogPlain();
                    }
                }
            };

            socket.onclose = () => {
                status.innerText = "WS: DISCONNECTED (Retrying...)";
                status.style.color = "red";
                setTimeout(connect, 3000);
            };

            socket.onerror = (err) => {
                console.error("Chyba WebSocketu:", err);
                socket.close();
            };
        }

        // Pomocná funkcia pre reset do čiernej ak nie je mapa
        function initFogPlain() {
            fogCanvas.width = window.innerWidth;
            fogCanvas.height = window.innerHeight;
            fogCanvas.style.left = "0px";
            fogCanvas.style.top = "0px";
            fogCtx.fillStyle = "black";
            fogCtx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
        }

        connect();
    </script>
</body>
</html>
